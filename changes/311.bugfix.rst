Fix abs_deriv handling of off-edge and nan values.
